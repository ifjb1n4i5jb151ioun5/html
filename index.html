<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS HTML Viewer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#131313">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Enter config">
    <link rel="stylesheet" href="pico.css">
    <link rel="stylesheet" href="style.css">
    <script src="crypto.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.3/src/sha3.js"></script>
</head>

<body>
    <div id="fadeOverlay"></div>
    <main>
        <article id="uploadFile">
            <button id="rememberedpasswordbutton">Password Saved</button>
            <button id="clearPasswordButton" style="display: none;">Clear Password</button>
            <button id="passwordfieldButton">Enter Password...</button>
            <input type="password" id="passwordField" style="display: none;">
            <button id="uploadfilebutton">Upload File</button>
            <div id="renderContainer">
                <input type="file" id="renderFileInput">
                <button id="viewbutton" style="display: none;">Decrypt and Render</button>
            </div>
            <div id="configContainer">
                <input type="file" id="configFileInput">
                <button id="applyconfigbutton">Apply Config</button>
            </div>
            <button id="uploadIconConfigButton">Upload Config</button>
        </article>
        <div id="refreshNote">
            <article>
                <strong><span id="renderText" aria-busy="true">Decrypting</span></strong>
            </article>
        </div>
    </main>
    <dialog id="alertDialog">
        <article>
            <p id="alertMessage">File required</p>
            <button data-target="alertDialog">OK</button>
        </article>
    </dialog>
    <script>
        function showAlert(message) {
            const alertDialog = document.getElementById('alertDialog');
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.innerHTML = message;
            alertDialog.showModal();
            document.querySelectorAll('[data-target="alertDialog"]').forEach(function (element) {
                element.addEventListener('click', function () {
                    alertDialog.close();
                });
            });
        }

        function updateRememberPasswordState() {
            const savedPassword = getSavedPassword();
            const rememberedpasswordbutton = document.getElementById('rememberedpasswordbutton');
            const passwordfieldButton = document.getElementById('passwordfieldButton');
            const clearPasswordButton = document.getElementById('clearPasswordButton');

            if (savedPassword) {
                rememberedpasswordbutton.style.display = 'inline-block';
                passwordfieldButton.style.display = 'none';
            } else {
                rememberedpasswordbutton.style.display = 'none';
                clearPasswordButton.style.display = 'none';
            }
        }

        function savePassword() {
            const password = document.getElementById('passwordField').value;
            localStorage.setItem('decryptionPassword', password);
            updateRememberPasswordState();
        }

        function getSavedPassword() {
            return localStorage.getItem('decryptionPassword');
        }

        function clearSavedPassword() {
            localStorage.removeItem('decryptionPassword');
            updateRememberPasswordState();
        }

        async function computeFileHash(file) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', await file.arrayBuffer());
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function loadAllowedHashes() {
            return fetch('https://raw.githubusercontent.com/ifjb1n4i5jb151ioun5/allowed-hashes/refs/heads/main/allowed-hashes.txt')
                .then(response => response.text())
                .then(text => text.split('\n').filter(hash => hash.trim() !== ''))
                .catch(error => {
                    console.error('Error loading allowed hashes:', error);
                    return [];
                });
        }

        function decryptFile(encryptedContent, key) {
            const decryptedData = new Uint8Array(encryptedContent.length);

            // Simple XOR decryption (same as encryption)
            for (let i = 0; i < encryptedContent.length; i++) {
                decryptedData[i] = encryptedContent[i] ^ key.charCodeAt(i % key.length);
            }

            return new TextDecoder().decode(decryptedData);
        }

        document.addEventListener("DOMContentLoaded", function () {
            const configFileInput = document.getElementById('configFileInput');
            const renderFileInput = document.getElementById('renderFileInput');
            const passwordButton = document.getElementById('passwordfieldButton');
            const passwordField = document.getElementById('passwordField');
            const applyConfigButton = document.getElementById('applyconfigbutton');
            const viewbutton = document.getElementById('viewbutton');
            const refreshNote = document.getElementById('refreshNote');
            const renderText = document.getElementById('renderText');
            const uploadFile = document.getElementById('uploadFile');
            const uploadfilebutton = document.getElementById('uploadfilebutton');
            const clearPasswordButton = document.getElementById("clearPasswordButton");
            const uploadIconConfigButton = document.getElementById('uploadIconConfigButton');

            updateRememberPasswordState();

            passwordButton.style.display = 'none';
            applyConfigButton.style.display = 'none';
            configFileInput.style.display = 'none';
            renderFileInput.style.display = 'none';

            if (window.navigator.standalone) { // Standalone Mode
                uploadIconConfigButton.style.display = "none";
                clearPasswordButton.style.display = "none";
            } else { // Regular Mode
                renderFileInput.style.display = "none";
                viewbutton.style.display = "none";
                clearPasswordButton.style.display = "none";
                uploadfilebutton.style.display = "none";
            }

            configFileInput.addEventListener('change', function () {
                if (configFileInput.files.length > 0) {
                    uploadIconConfigButton.style.display = 'none';
                    applyConfigButton.style.display = 'none';
                    passwordButton.style.display = 'inline-block';
                    applyConfigButton.style.display = 'inline-block';
                } else {
                    applyConfigButton.style.display = 'inline-block';
                }
            });

            renderFileInput.addEventListener('change', function () {
                if (renderFileInput.files.length > 0) {
                    passwordfieldButton.style.display = 'inline-block';
                    viewbutton.style.display = 'inline-block';
                    clearPasswordButton.style.display = 'inline-block';
                    uploadfilebutton.style.display = 'none';
                    updateRememberPasswordState();
                    fillPasswordField();
                } else {
                    uploadfilebutton.style.display = 'inline-block';
                    viewbutton.style.display = 'none';
                    renderFileInput.style.display = 'none';
                }
            });

            passwordButton.addEventListener('click', function () {
                passwordButton.style.display = 'none';
                passwordField.style.display = 'inline-block';
                passwordField.focus();
            });

            applyConfigButton.addEventListener('click', function () {
                processConfigFile();
            });

            function fillPasswordField() {
                const savedPassword = getSavedPassword();
                if (savedPassword) {
                    document.getElementById('passwordField').value = savedPassword;
                }
            }

            viewbutton.addEventListener('click', async function () {
                const fileInput = document.getElementById('renderFileInput');
                const passwordFieldValue = passwordField.value;

                if (fileInput.files.length > 0 && passwordFieldValue) {
                    const file = fileInput.files[0];

                    // Compute the hash of the uploaded file
                    const computedHash = await computeFileHash(file);
                    console.log("Computed Hash:", computedHash);

                    // Fetch allowed hashes
                    const allowedHashes = await loadAllowedHashes();

                    // Check if the computed hash is in the allowed hashes
                    if (allowedHashes.includes(computedHash)) {
                        const reader = new FileReader();

                        reader.onload = function (event) {
                            const encryptedContent = new Uint8Array(event.target.result);
                            const decryptedContent = decryptFile(encryptedContent, passwordFieldValue);

                            // Render or use decrypted content as needed
                            document.open();
                            document.write(decryptedContent);
                            document.close();

                            console.log("File decrypted and rendered.");
                        };

                        reader.readAsArrayBuffer(file); // Read as ArrayBuffer for decryption
                    } else {
                        showAlert(`File hash is not allowed: ${computedHash}`); // Notify user
                    }
                } else {
                    showAlert('Please select a file and enter a password.');
                }
            });

            // Clear saved password functionality
            document.getElementById('clearPasswordButton').addEventListener('click', function () {
                clearSavedPassword();
                showAlert('Saved password has been cleared.');
            });

            uploadIconConfigButton.addEventListener('click', function () {
                configFileInput.click();
            });

            uploadfilebutton.addEventListener('click', function () {
                renderFileInput.click();
            });
        });          
    </script>

</body>

</html>