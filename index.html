<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS HTML Viewer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#131313">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Enter config">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.classless.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body>
    <div id="fadeOverlay"></div>
    <main>
        <article id="uploadFile">
            <button id="passwordfieldButton">Enter Password...</button>
            <input type="password" id="passwordField" style="display: none;">
            <button id="rememberedpasswordbutton">Saved Password</button>
            <button id="uploadfilebutton">Upload File</button>
            <div id="renderContainer">
                <input type="file" id="renderFileInput">
                <button id="viewbutton" style="display: none;">Decrypt and Render</button>
            </div>
            <div id="configContainer">
                <input type="file" id="configFileInput">
                <button id="applyconfigbutton">Apply Config</button>
            </div>
            <div id="rememberPasswordContainer" style="display: none;">
                <input type="checkbox" id="rememberPassword">
                <label id="rememberPasswordText" for="rememberPassword">Remember password</label>
            </div>
            <button id="uploadIconConfigButton">Upload Config</button>
            <button id="clearPasswordButton" style="display: none;">Clear Password</button>
        </article>
        <div id="refreshNote">
            <article>
                <strong><span id="renderText" aria-busy="true">Decrypting</span></strong>
            </article>
        </div>
    </main>
    <dialog id="alertDialog">
        <article>
            <p id="alertMessage">File required</p>
            <button data-target="alertDialog">OK</button>
        </article>
    </dialog>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script>
        function showAlert(message) {
            const alertDialog = document.getElementById('alertDialog');
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.innerHTML = message;
            alertDialog.showModal();
            document.querySelectorAll('[data-target="alertDialog"]').forEach(function (element) {
                element.addEventListener('click', function () {
                    alertDialog.close();
                });
            });
        }

        function updateRememberedPasswordButtonVisibility() {
            const rememberedPasswordButton = document.getElementById('rememberedpasswordbutton');
            const passwordfieldButton = document.getElementById('passwordfieldButton');
            const savedPassword = getSavedPassword();
            rememberedPasswordButton.style.display = savedPassword ? 'inline-block' : 'none';
            passwordfieldButton.style.display = savedPassword ? 'none' : 'inline-block';
        }
        
        function updateRememberPasswordState() {
            const rememberPasswordCheckbox = document.getElementById('rememberPassword');
            const rememberPasswordText = document.getElementById('rememberPasswordText');
            const savedPassword = getSavedPassword();

            if (savedPassword) {
                rememberPasswordCheckbox.checked = true;
                rememberPasswordCheckbox.disabled = true;
                rememberPasswordText.textContent = 'Password saved';
            } else {
                rememberPasswordCheckbox.checked = false;
                rememberPasswordCheckbox.disabled = false;
                rememberPasswordText.textContent = 'Remember password';
            }
        }

        function savePassword() {
            const password = document.getElementById('passwordField').value;
            if (document.getElementById('rememberPassword').checked && password) {
                localStorage.setItem('decryptionPassword', password);
                updateRememberPasswordState();
                updateRememberedPasswordButtonVisibility();
            }
        }

        function getSavedPassword() {
            return localStorage.getItem('decryptionPassword');
        }

        function clearSavedPassword() {
            localStorage.removeItem('decryptionPassword');
            updateRememberPasswordState();
            updateRememberedPasswordButtonVisibility();
        }

        function processConfigFile() {
            const file = configFileInput.files[0];
            const password = document.getElementById('passwordField').value;

            if (file && password) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const encryptedContent = event.target.result;
                    try {
                        const decrypted = CryptoJS.AES.decrypt(encryptedContent, password).toString(CryptoJS.enc.Utf8);
                        if (decrypted) {
                            const [iconUrl, appTitle] = decrypted.split('\n');
                            if (iconUrl && appTitle) {
                                updateIconAndTitle(iconUrl, appTitle);
                                const applyButton = document.getElementById('applyconfigbutton');
                                applyButton.classList.add('button-success');
                                applyButton.innerHTML = '<span>Apply Config</span>';
                                setTimeout(() => {
                                    applyButton.classList.remove('button-success');
                                    applyButton.textContent = 'Apply Config';
                                    savePassword()
                                }, 2000);
                            } else {
                                showAlert('Invalid icon config file format.');
                            }
                        } else {
                            showAlert('Decryption failed. Incorrect password or invalid file format.');
                        }
                    } catch (error) {
                        showAlert('Decryption error: ' + error.message);
                    }
                };
                reader.readAsText(file);
            } else {
                showAlert('Please select a file and enter a password.');
            }
        }

        function updateIconAndTitle(iconUrl, appTitle) {
            const appleTouchIcon = document.querySelector('link[rel="apple-touch-icon"]');
            if (appleTouchIcon) {
                appleTouchIcon.href = iconUrl;
            } else {
                const newLink = document.createElement('link');
                newLink.rel = 'apple-touch-icon';
                newLink.href = iconUrl;
                document.head.appendChild(newLink);
            }
            const appTitleMeta = document.querySelector('meta[name="apple-mobile-web-app-title"]');
            if (appTitleMeta) {
                appTitleMeta.content = appTitle;
            } else {
                const newMeta = document.createElement('meta');
                newMeta.name = 'apple-mobile-web-app-title';
                newMeta.content = appTitle;
                document.head.appendChild(newMeta);
            }

            document.title = appTitle;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const configFileInput = document.getElementById('configFileInput');
            const renderFileInput = document.getElementById('renderFileInput');
            const passwordButton = document.getElementById('passwordfieldButton');
            const passwordField = document.getElementById('passwordField');
            const applyConfigButton = document.getElementById('applyconfigbutton');
            const viewbutton = document.getElementById('viewbutton');
            const refreshNote = document.getElementById('refreshNote');
            const renderText = document.getElementById('renderText');
            const uploadFile = document.getElementById('uploadFile');
            const uploadfilebutton = document.getElementById('uploadfilebutton');
            const passwordfieldButton = document.getElementById('passwordfieldButton');
            const uploadFileButton = document.getElementById('uploadfilebutton');
            const rememberPasswordContainer = document.getElementById("rememberPasswordContainer");
            const clearPasswordButton = document.getElementById("clearPasswordButton");
            const uploadIconConfigButton = document.getElementById('uploadIconConfigButton');

            updateRememberedPasswordButtonVisibility();

            updateRememberPasswordState();

            passwordButton.style.display = 'none';
            applyConfigButton.style.display = 'none';
            configFileInput.style.display = 'none';
            renderFileInput.style.display = 'none';

            if (window.navigator.standalone) { // Standalone Mode
                document.getElementById("uploadIconConfigButton").style.display = "none";
                rememberPasswordContainer.style.display = "none";
                clearPasswordButton.style.display = "none";
            } else { // Regular Mode
                renderFileInput.style.display = "none";
                viewbutton.style.display = "none";
                rememberPasswordContainer.style.display = "none";
                clearPasswordButton.style.display = "none";
                uploadfilebutton.style.display = "none";
            }

            configFileInput.addEventListener('change', function () {
                if (configFileInput.files.length > 0) {
                    uploadIconConfigButton.style.display = 'none';
                    applyConfigButton.style.display = 'none';
                    passwordButton.style.display = 'inline-block';
                    applyConfigButton.style.display = 'inline-block';
                } else {
                    applyConfigButton.style.display = 'inline-block';
                }
            });

            renderFileInput.addEventListener('change', function () {
                if (renderFileInput.files.length > 0) {
                    passwordfieldButton.style.display = 'inline-block';
                    viewbutton.style.display = 'inline-block';
                    rememberPasswordContainer.style.display = 'inline-block';
                    clearPasswordButton.style.display = 'inline-block';
                    uploadfilebutton.style.display = 'none';
                } else {
                    uploadFileButton.style.display = 'inline-block';
                    viewbutton.style.display = 'none';
                    renderFileInput.style.display = 'none';
                }
            });

            passwordButton.addEventListener('click', function () {
                passwordButton.style.display = 'none';
                passwordField.style.display = 'block';
                passwordField.focus();
            });

            applyConfigButton.addEventListener('click', function () {
                processConfigFile();
            });

            viewbutton.addEventListener('click', function () {
                const file = renderFileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const encryptedContent = event.target.result;
                        let passphrase = passwordField.value;
                        if (!passphrase) {
                            passphrase = getSavedPassword();
                        }
                        if (passphrase) {
                            try {
                                renderText.textContent = `Decrypting "${file.name}"`;
                                uploadFile.style.display = 'none';
                                refreshNote.style.display = 'block';
                                setTimeout(function () {
                                    const decrypted = CryptoJS.AES.decrypt(encryptedContent, passphrase).toString(CryptoJS.enc.Utf8);
                                    if (decrypted) {
                                        renderText.textContent = `Rendering "${file.name}"`;
                                        savePassword();
                                        setTimeout(function () {
                                            document.open();
                                            document.write(decrypted);
                                            document.close();
                                            window.addEventListener('load', function () {
                                                console.log('New page fully loaded');
                                            });
                                        }, 2000);
                                    } else {
                                        showAlert('Decryption failed. Incorrect password or invalid file format.');
                                        uploadFile.style.display = 'block';
                                        refreshNote.style.display = 'none';
                                        clearSavedPassword();
                                    }
                                }, 2000);
                            } catch (error) {
                                showAlert('Decryption error: ' + error.message);
                                uploadFile.style.display = 'block';
                                refreshNote.style.display = 'none';
                                clearSavedPassword();
                            }
                        } else {
                            showAlert('Password is required for decryption.');
                            uploadFile.style.display = 'block';
                            refreshNote.style.display = 'none';
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showAlert('Select file before decrypting');
                }
            });

            document.getElementById('clearPasswordButton').addEventListener('click', function () {
                clearSavedPassword();
                showAlert('Saved password has been cleared.');
            });

            uploadIconConfigButton.addEventListener('click', function () {
                configFileInput.click();
            });

            uploadfilebutton.addEventListener('click', function () {
                renderFileInput.click();
            });
        });          
    </script>
</body>

</html>