<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS HTML Viewer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#131313">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Enter config">
    <link rel="stylesheet" href="pico.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.3/src/sha3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
</head>

<body>
    <div id="fadeOverlay"></div>
    <main>
        <div id="initial-setup-title">Initial Setup</div>
        <article id="restart" style="display: none;">
            <button id="rememberedpasswordbutton">Password Saved</button>
            <button id="savedfilebutton">File Saved</button>
            <button id="clearPasswordButton" style="display: none;">Clear Password</button>
        </article>
        <article id="uploadFile">
            <button id="passwordfieldButton">Enter Password...</button>
            <input type="password" id="passwordField" style="display: none;">
            <button id="uploadfilebutton">Upload File</button>
            <div id="renderContainer">
                <input type="file" id="renderFileInput">
                <button id="viewbutton" style="display: none;">Decrypt and Render</button>
            </div>
            <div id="configContainer">
                <input type="file" id="configFileInput">
                <button id="applyconfigbutton">Apply Config</button>
            </div>
            <button id="uploadIconConfigButton">Upload Config</button>
        </article>
        <div id="refreshNote">
            <article>
                <strong><span id="renderText" aria-busy="true">Decrypting</span></strong>
            </article>
        </div>
    </main>

    <dialog id="alertDialog">
        <article>
            <p id="alertMessage">File required</p>
            <button data-target="alertDialog">OK</button>
        </article>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.3/src/sha3.js"></script>
    <script>
        function showAlert(message) {
            const alertDialog = document.getElementById('alertDialog');
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.innerHTML = message;
            alertDialog.showModal();
            document.querySelectorAll('[data-target="alertDialog"]').forEach(function (element) {
                element.addEventListener('click', function () {
                    alertDialog.close();
                });
            });
        }

        async function computeFileHash(file) {
            const fileContent = await file.text();
            return sha3_256(fileContent);
        }

        async function loadAllowedHashes() {
            const timestamp = new Date().getTime();
            return fetch(`https://raw.githubusercontent.com/ifjb1n4i5jb151ioun5/allowed-hashes/refs/heads/main/allowed-hashes.txt?t=${timestamp}`)
                .then(response => response.text())
                .then(text => text.split('\n').filter(hash => hash.trim() !== ''))
                .catch(error => {
                    console.error('Error loading allowed hashes:', error);
                    return [];
                });
        }

        function aesDecrypt(encryptedContent, key) {
            const fullCipher = CryptoJS.enc.Base64.parse(encryptedContent);
            const iv = fullCipher.words.slice(0, 4);
            const ciphertext = fullCipher.words.slice(4);

            const decrypted = CryptoJS.AES.decrypt(
                { ciphertext: CryptoJS.lib.WordArray.create(ciphertext) },
                CryptoJS.enc.Utf8.parse(key),
                { iv: CryptoJS.lib.WordArray.create(iv) }
            );

            return decrypted.toString(CryptoJS.enc.Utf8);
        }

        function savePassword(password) {
            localStorage.setItem('encryptionPassword', password);
            document.getElementById('uploadfile').style.display = 'none';
            document.getElementById('restart').style.display = 'block';
        }

        function clearSavedPassword() {
            localStorage.removeItem('encryptionPassword');
            document.getElementById('rememberedpasswordbutton').style.display = 'none';
            document.getElementById('clearPasswordButton').style.display = 'none';
            document.getElementById('passwordField').value = '';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const configFileInput = document.getElementById('configFileInput');
            const renderFileInput = document.getElementById('renderFileInput');
            const passwordButton = document.getElementById('passwordfieldButton');
            const passwordField = document.getElementById('passwordField');
            const applyConfigButton = document.getElementById('applyconfigbutton');
            const viewbutton = document.getElementById('viewbutton');
            const refreshNote = document.getElementById('refreshNote');
            const renderText = document.getElementById('renderText');
            const uploadFile = document.getElementById('uploadFile');
            const uploadfilebutton = document.getElementById('uploadfilebutton');
            const clearPasswordButton = document.getElementById("clearPasswordButton");
            const uploadIconConfigButton = document.getElementById('uploadIconConfigButton');
            const savedPassword = localStorage.getItem('encryptionPassword');
            const savedFile = localStorage.getItem('savedFile');
            const filebutton = document.getElementById('savedfilebutton');

            passwordButton.style.display = 'none';
            applyConfigButton.style.display = 'none';
            configFileInput.style.display = 'none';
            renderFileInput.style.display = 'none';
            filebutton.style.display = 'none';

            updatePasswordButtonVisibility();

            function updatePasswordButtonVisibility() {
                if (!savedPassword && renderFileInput.files.length > 0) {
                    passwordButton.style.display = 'inline-block'; // Show button if no password and file is uploaded
                } else {
                    passwordButton.style.display = 'none'; // Hide otherwise
                }
            }

            if (window.navigator.standalone) {
                uploadIconConfigButton.style.display = "none";
            } else {
                passwordButton.style.display = "none";
                renderFileInput.style.display = "none";
                viewbutton.style.display = "none";
                uploadfilebutton.style.display = "none";
            }

            if (savedFile) {
                document.getElementById('savedfilebutton').style.display = 'inline-block';
            }

            configFileInput.addEventListener('change', function () {
                if (configFileInput.files.length > 0) {
                    uploadIconConfigButton.style.display = 'none';
                    applyConfigButton.style.display = 'none';
                    passwordButton.style.display = 'inline-block';
                    applyConfigButton.style.display = 'inline-block';
                } else {
                    applyConfigButton.style.display = 'inline-block';
                }
            });

            renderFileInput.addEventListener('change', function () {
                if (renderFileInput.files.length > 0) {
                    viewbutton.style.display = 'inline-block';
                    uploadfilebutton.style.display = 'none';
                } else {
                    uploadfilebutton.style.display = 'inline-block';
                    viewbutton.style.display = 'none';
                    renderFileInput.style.display = 'none';
                }
            });

            passwordButton.addEventListener('click', function () {
                passwordButton.style.display = 'none';
                passwordField.style.display = 'inline-block';
                passwordField.focus();
            });

            function processConfigFile() {
                const file = configFileInput.files[0];
                const password = document.getElementById('passwordField').value;

                if (file && password) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const encryptedContent = event.target.result;
                        try {
                            const decrypted =
                                CryptoJS.AES.decrypt(encryptedContent, password).toString(CryptoJS.enc.Utf8);
                            if (decrypted) {
                                const [iconUrl, appTitle] = decrypted.split('\n');
                                if (iconUrl && appTitle) {
                                    updateIconAndTitle(iconUrl, appTitle);
                                    const applyButton =
                                        document.getElementById('applyconfigbutton');
                                    applyButton.classList.add('button-success');
                                    applyButton.innerHTML =
                                        '<span>Apply Config</span>';
                                    setTimeout(() => {
                                        applyButton.classList.remove(
                                            'button-success'
                                        );
                                        applyButton.textContent =
                                            'Apply Config';
                                    }, 2000);
                                } else {
                                    showAlert(
                                        'Invalid icon config file format.'
                                    );
                                }
                            } else {
                                showAlert(
                                    'Decryption failed. Incorrect password or invalid file format.'
                                );
                            }
                        } catch (error) {
                            showAlert(
                                'Decryption error: ' + error.message
                            );
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showAlert(
                        'Please select a file and enter a password.'
                    );
                }
            }

            function updateIconAndTitle(iconUrl, appTitle) {
                const appleTouchIcon =
                    document.querySelector('link[rel="apple-touch-icon"]');
                if (appleTouchIcon) {
                    appleTouchIcon.href = iconUrl;
                } else {
                    const newLink =
                        document.createElement('link');
                    newLink.rel =
                        'apple-touch-icon';
                    newLink.href =
                        iconUrl;
                    document.head.appendChild(newLink);
                }
                const appTitleMeta =
                    document.querySelector(
                        'meta[name="apple-mobile-web-app-title"]'
                    );
                if (appTitleMeta) {
                    appTitleMeta.content =
                        appTitle;
                } else {
                    const newMeta =
                        document.createElement(
                            'meta'
                        );
                    newMeta.name =
                        'apple-mobile-web-app-title';
                    newMeta.content =
                        appTitle;
                    document.head.appendChild(newMeta);
                }

                document.title =
                    appTitle;
            }

            function saveUploadedFile(file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const base64String = event.target.result.split(',')[1]; // Get Base64 string
                    localStorage.setItem('savedFile', base64String);
                };
                reader.readAsDataURL(file);
            }

            viewbutton.addEventListener('click', async function () {
                const fileInput = document.getElementById('renderFileInput');
                let passwordFieldValue = passwordField.value || localStorage.getItem('encryptionPassword');

                const savedFile = localStorage.getItem('savedFile');
                if (savedFile && passwordFieldValue) {
                    try {
                        const encryptedContent = atob(savedFile); // Decode Base64
                        const decryptedContent = aesDecrypt(encryptedContent, passwordFieldValue);
                        savePassword(passwordFieldValue);

                        const blob = new Blob([decryptedContent], { type: 'text/plain' });

                        const decryptedHash = await computeFileHash(blob);

                        const allowedHashes = await loadAllowedHashes();
                        if (allowedHashes.includes(decryptedHash)) {
                            document.open();
                            document.write(decryptedContent);
                            document.close();
                        } else {
                            showAlert(`The encrypted file is not allowed. Calculated hash: ${encryptedHash}`);
                        }
                    } catch (error) {
                        showAlert(`Decryption failed. Please check your password. Calculated hash: ${encryptedHash}`);
                    }
                } else {
                    showAlert('No saved file or password available.');
                }
            });

            renderFileInput.addEventListener('change', function () {
                if (renderFileInput.files.length > 0) {
                    const file =
                        renderFileInput.files[0];
                    saveUploadedFile(file); // Call save function on file upload
                    viewbutton.style.display =
                        'inline-block'; // Show decrypt button
                }
            });

            applyConfigButton.addEventListener(
                'click',
                function () { processConfigFile(); }
            );

            uploadIconConfigButton.addEventListener(
                'click',
                function () { configFileInput.click(); }
            );

            uploadfilebutton.addEventListener(
                'click',
                function () { renderFileInput.click(); }
            );

            clearPasswordButton.addEventListener(
                'click',
                clearSavedPassword
            );

            // Check for file changes
            renderFileInput.addEventListener(
                'change',
                function () { updatePasswordButtonVisibility(); } // Update visibility when a file is uploaded
            );

            // Automatically decrypt and render saved file on page load if available
            if (localStorage.getItem('savedFile') && localStorage.getItem('encryptionPassword')) {
                const savedEncryptedContent = localStorage.getItem('savedFile');
                const savedPasswordValue = localStorage.getItem('encryptionPassword');

                try {
                    const decryptedContent =
                        aesDecrypt(atob(savedEncryptedContent), savedPasswordValue);
                    document.open();
                    document.write(decryptedContent);
                    document.close();
                } catch (error) {
                    showAlert(
                        'Failed to automatically decrypt the saved file. Please check your password.'
                    );
                }
            }

        });
    </script>

</body>

</html>