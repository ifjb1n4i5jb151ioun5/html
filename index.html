<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS HTML Viewer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#131313">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Enter config">
    <link rel="stylesheet" href="pico.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.3/src/sha3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
</head>

<body>
    <div id="fadeOverlay"></div>
    <main>
        <article id="uploadFile">
            <button id="rememberedpasswordbutton" style="display: none;">Password Saved</button>
            <button id="clearPasswordButton" style="display: none;">Clear Password</button>
            <button id="passwordfieldButton">Enter Password...</button>
            <input type="password" id="passwordField" style="display: none;">
            <button id="uploadfilebutton">Upload File</button>
            <div id="renderContainer">
                <input type="file" id="renderFileInput">
                <button id="viewbutton" style="display: none;">Decrypt and Render</button>
            </div>
            <div id="configContainer">
                <input type="file" id="configFileInput">
                <button id="applyconfigbutton">Apply Config</button>
            </div>
            <button id="uploadIconConfigButton">Upload Config</button>
        </article>
        <div id="refreshNote">
            <article>
                <strong><span id="renderText" aria-busy="true">Decrypting</span></strong>
            </article>
        </div>
    </main>

    <dialog id="alertDialog">
        <article>
            <p id="alertMessage">File required</p>
            <button data-target="alertDialog">OK</button>
        </article>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.3/src/sha3.js"></script>
    <script>
        function showAlert(message) {
            const alertDialog = document.getElementById('alertDialog');
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.innerHTML = message;
            alertDialog.showModal();
            document.querySelectorAll('[data-target="alertDialog"]').forEach(function (element) {
                element.addEventListener('click', function () {
                    alertDialog.close();
                });
            });
        }

        async function computeFileHash(file) {
            const fileContent = await file.text();
            return sha3_256(fileContent);
        }

        async function loadAllowedHashes() {
            const timestamp = new Date().getTime();
            return fetch(`https://raw.githubusercontent.com/ifjb1n4i5jb151ioun5/allowed-hashes/refs/heads/main/allowed-hashes.txt?t=${timestamp}`)
                .then(response => response.text())
                .then(text => text.split('\n').filter(hash => hash.trim() !== ''))
                .catch(error => {
                    console.error('Error loading allowed hashes:', error);
                    return [];
                });
        }

        function aesDecrypt(encryptedContent, key) {
            const fullCipher = CryptoJS.enc.Base64.parse(encryptedContent);
            const iv = fullCipher.words.slice(0, 4);
            const ciphertext = fullCipher.words.slice(4);

            const decrypted = CryptoJS.AES.decrypt(
                { ciphertext: CryptoJS.lib.WordArray.create(ciphertext) },
                CryptoJS.enc.Utf8.parse(key),
                { iv: CryptoJS.lib.WordArray.create(iv) }
            );

            return decrypted.toString(CryptoJS.enc.Utf8);
        }

        function savePassword(password) {
            localStorage.setItem('encryptionPassword', password);
            document.getElementById('rememberedpasswordbutton').style.display = 'inline-block';
            document.getElementById('clearPasswordButton').style.display = 'inline-block';
        }

        function clearSavedPassword() {
            localStorage.removeItem('encryptionPassword');
            document.getElementById('rememberedpasswordbutton').style.display = 'none';
            document.getElementById('clearPasswordButton').style.display = 'none';
            document.getElementById('passwordField').value = '';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const configFileInput = document.getElementById('configFileInput');
            const renderFileInput = document.getElementById('renderFileInput');
            const passwordButton = document.getElementById('passwordfieldButton');
            const passwordField = document.getElementById('passwordField');
            const applyConfigButton = document.getElementById('applyconfigbutton');
            const viewbutton = document.getElementById('viewbutton');
            const refreshNote = document.getElementById('refreshNote');
            const renderText = document.getElementById('renderText');
            const uploadFile = document.getElementById('uploadFile');
            const uploadfilebutton = document.getElementById('uploadfilebutton');
            const clearPasswordButton = document.getElementById("clearPasswordButton");
            const uploadIconConfigButton = document.getElementById('uploadIconConfigButton');
            const savedPassword = localStorage.getItem('encryptionPassword');

            passwordButton.style.display = 'inline-block';
            applyConfigButton.style.display = 'none';
            configFileInput.style.display = 'none';
            renderFileInput.style.display = 'none';

            if (window.navigator.standalone) {
                uploadIconConfigButton.style.display = "none";
            } else {
                passwordButton.style.display = "none";
                renderFileInput.style.display = "none";
                viewbutton.style.display = "none";
                uploadfilebutton.style.display = "none";
            }

            if (savedPassword) {
                document.getElementById('rememberedpasswordbutton').style.display = 'inline-block';
                document.getElementById('clearPasswordButton').style.display = 'inline-block';
                document.getElementById('passwordfieldButton').style.display = 'none';
            }

            configFileInput.addEventListener('change', function () {
                if (configFileInput.files.length > 0) {
                    uploadIconConfigButton.style.display = 'none';
                    applyConfigButton.style.display = 'none';
                    passwordButton.style.display = 'inline-block';
                    applyConfigButton.style.display = 'inline-block';
                } else {
                    applyConfigButton.style.display = 'inline-block';
                }
            });

            renderFileInput.addEventListener('change', function () {
                if (renderFileInput.files.length > 0) {
                    viewbutton.style.display = 'inline-block';
                    uploadfilebutton.style.display = 'none';
                } else {
                    uploadfilebutton.style.display = 'inline-block';
                    viewbutton.style.display = 'none';
                    renderFileInput.style.display = 'none';
                }
            });

            passwordButton.addEventListener('click', function () {
                passwordButton.style.display = 'none';
                passwordField.style.display = 'inline-block';
                passwordField.focus();
            });

            function processConfigFile() {
                const file = configFileInput.files[0];
                const password = document.getElementById('passwordField').value;

                if (file && password) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const encryptedContent = event.target.result;
                        try {
                            const decrypted = CryptoJS.AES.decrypt(encryptedContent, password).toString(CryptoJS.enc.Utf8);
                            if (decrypted) {
                                const [iconUrl, appTitle] = decrypted.split('\n');
                                if (iconUrl && appTitle) {
                                    updateIconAndTitle(iconUrl, appTitle);
                                    const applyButton = document.getElementById('applyconfigbutton');
                                    applyButton.classList.add('button-success');
                                    applyButton.innerHTML = '<span>Apply Config</span>';
                                    setTimeout(() => {
                                        applyButton.classList.remove('button-success');
                                        applyButton.textContent = 'Apply Config';
                                    }, 2000);
                                } else {
                                    showAlert('Invalid icon config file format.');
                                }
                            } else {
                                showAlert('Decryption failed. Incorrect password or invalid file format.');
                            }
                        } catch (error) {
                            showAlert('Decryption error: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    showAlert('Please select a file and enter a password.');
                }
            }

            function updateIconAndTitle(iconUrl, appTitle) {
                const appleTouchIcon = document.querySelector('link[rel="apple-touch-icon"]');
                if (appleTouchIcon) {
                    appleTouchIcon.href = iconUrl;
                } else {
                    const newLink = document.createElement('link');
                    newLink.rel = 'apple-touch-icon';
                    newLink.href = iconUrl;
                    document.head.appendChild(newLink);
                }
                const appTitleMeta = document.querySelector('meta[name="apple-mobile-web-app-title"]');
                if (appTitleMeta) {
                    appTitleMeta.content = appTitle;
                } else {
                    const newMeta = document.createElement('meta');
                    newMeta.name = 'apple-mobile-web-app-title';
                    newMeta.content = appTitle;
                    document.head.appendChild(newMeta);
                }

                document.title = appTitle;
            }

            applyConfigButton.addEventListener('click', function () {
                processConfigFile();
            });

            viewbutton.addEventListener('click', async function () {
                const fileInput = document.getElementById('renderFileInput');
                let passwordFieldValue = passwordField.value;

                // Check if there's a saved password
                if (!passwordFieldValue) {
                    passwordFieldValue = localStorage.getItem('encryptionPassword');
                }

                if (fileInput.files.length > 0 && passwordFieldValue) {
                    const file = fileInput.files[0];

                    try {
                        const computedHash = await computeFileHash(file);
                        console.log("Computed Hash:", computedHash);

                        const allowedHashes = await loadAllowedHashes();

                        if (allowedHashes.includes(computedHash)) {
                            const reader = new FileReader();

                            reader.onload = function (event) {
                                const encryptedContent = event.target.result;
                                try {
                                    const decryptedContent = aesDecrypt(encryptedContent, passwordFieldValue);
                                    document.open();
                                    document.write(decryptedContent);
                                    document.close();

                                    // Save the password if decryption was successful
                                    savePassword(passwordFieldValue);
                                } catch (decryptionError) {
                                    console.error('Decryption failed:', decryptionError);
                                    showAlert('Decryption failed. Please check your password.');
                                }
                            };

                            reader.readAsText(file);
                        } else {
                            showAlert(`File hash is not allowed: ${computedHash}`);
                        }
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showAlert('An error occurred while processing the file.');
                    }
                } else {
                    showAlert('Please select a file and enter a password.');
                }
            });

            uploadIconConfigButton.addEventListener('click', function () {
                configFileInput.click();
            });

            uploadfilebutton.addEventListener('click', function () {
                renderFileInput.click();
            });

            clearPasswordButton.addEventListener('click', clearSavedPassword);
        });
    </script>

</body>

</html>