<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS HTML Viewer</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#131313">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Enter Name...">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.classless.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.pumpkin.min.css">
    <link rel="stylesheet" href="style.css">

    <!-- Prism.js CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
            integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- CryptoJS for AES decryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loadingText {
            color: white;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <!-- Gradient overlay for opacity fade-out at the top -->
    <div id="fadeOverlay"></div>
        
    <main>
        <article id="uploadFile">
            <input type="file" id="fileInput">
            <button id="viewButton">Decrypt and Render</button>
            <button id="uploadIconConfigButton">Upload Config</button>
        </article>

        <div id="refreshNote">
            <article>
                <strong><span id="renderText" aria-busy="true">Decrypting</span></strong>
            </article>
        </div>
    </main>

    <!-- Modal for alerts -->
    <dialog id="alertDialog">
        <article>
            <p id="alertMessage">Select file before decrypting</p>
            <button data-target="alertDialog">OK</button>
        </article>
    </dialog>

    <!-- Help box -->
    <div id="helpBox">
        <button id="questionMarkButton" title="Help">?</button>
        <span id="helpText">Help</span>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>

    <!-- Prism.js JavaScript for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <script>
        // Show the alert dialog with a custom message
        function showAlert(message) {
            const alertDialog = document.getElementById('alertDialog');
            const alertMessage = document.getElementById('alertMessage');
            alertMessage.innerHTML = message;
            alertDialog.showModal();

            // Close dialog on 'OK' button click
            document.querySelectorAll('[data-target="alertDialog"]').forEach(function (element) {
                element.addEventListener('click', function () {
                    alertDialog.close();
                });
            });
        }

        window.onload = function() {
            const fileInput = document.getElementById('fileInput');
            const viewButton = document.getElementById('viewButton');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const refreshNote = document.getElementById('refreshNote');
            const renderText = document.getElementById('renderText');
            const uploadFile = document.getElementById('uploadFile');

            viewButton.addEventListener('click', function () {
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        const encryptedContent = event.target.result;
                        
                        // Prompt for passphrase
                        const passphrase = prompt("Enter the passphrase to decrypt the file:");
                        
                        if (passphrase) {
                            try {
                                // Show decrypting notification
                                renderText.textContent = `Decrypting "${file.name}"`;
                                uploadFile.style.display = 'none';
                                refreshNote.style.display = 'block';
                                loadingOverlay.style.display = 'flex';

                                // Decrypt the content
                                setTimeout(function() {
                                    const decrypted = CryptoJS.AES.decrypt(encryptedContent, passphrase).toString(CryptoJS.enc.Utf8);
                                    
                                    if (decrypted) {
                                        // Update the render text with the file name
                                        renderText.textContent = `Rendering "${file.name}"`;
                                        loadingText.textContent = `Rendering "${file.name}"`;

                                        // Wait 2 seconds before rendering the content (for visual feedback)
                                        setTimeout(function () {
                                            // Replace the entire document with the decrypted HTML content
                                            document.open();
                                            document.write(decrypted);
                                            document.close();

                                            // The new page will load, and its window.onload event will fire when ready
                                        }, 2000);
                                    } else {
                                        showAlert('Decryption failed. Incorrect passphrase or invalid file format.');
                                        uploadFile.style.display = 'block';
                                        refreshNote.style.display = 'none';
                                        loadingOverlay.style.display = 'none';
                                    }
                                }, 2000); // Show decryption message for 2 seconds
                            } catch (error) {
                                showAlert('Decryption error: ' + error.message);
                                uploadFile.style.display = 'block';
                                refreshNote.style.display = 'none';
                                loadingOverlay.style.display = 'none';
                            }
                        } else {
                            showAlert('Passphrase is required for decryption.');
                            uploadFile.style.display = 'block';
                            refreshNote.style.display = 'none';
                        }
                    };

                    reader.readAsText(file);
                } else {
                    showAlert('Select file before decrypting');
                }
            });
        };

        // Checks if the site is running as an app on the homescreen and hides the upload icon config button and help page if it is
        document.addEventListener("DOMContentLoaded", function () {
            if (window.navigator.standalone) {
                document.getElementById("uploadIconConfigButton").style.display = "none";
                document.getElementById("questionMarkButton").style.display = "none";
                document.getElementById("helpBox").style.display = "none"; // Hide the help box in standalone mode
            }
        });

        // Checks if the site is running in the browser and hides the file input and decrypt button if it is
        document.addEventListener("DOMContentLoaded", function () {
            if (!window.navigator.standalone) {
                document.getElementById("fileInput").style.display = "none";
                document.getElementById("viewButton").style.display = "none";
            }
        });

        document.getElementById('questionMarkButton').addEventListener('click', function () {
            showAlert('Step 1: Upload icon config<br>Step 2: Click the share button<br>Step 3: Add to homescreen<br> Step 4: Open the app');
        });

        document.addEventListener("DOMContentLoaded", function() {
            const viewButton = document.getElementById('viewButton');
            const fileInput = document.getElementById('fileInput');

            // Initially remove the glow effect
            viewButton.classList.remove('glow');

            // Add event listener to the file input
            fileInput.addEventListener('change', function() {
                // Check if a file is selected
                if (fileInput.files.length > 0) {
                    viewButton.classList.add('glow'); // Add glow effect
                } else {
                    viewButton.classList.remove('glow'); // Remove glow effect
                }
            });
        });

        // Function to handle icon config upload and processing
        function handleIconConfigUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const encryptedContent = e.target.result;
                    const passphrase = prompt("Enter the passphrase to decrypt the icon config file:");
                    
                    if (passphrase) {
                        try {
                            const decrypted = CryptoJS.AES.decrypt(encryptedContent, passphrase).toString(CryptoJS.enc.Utf8);
                            const [iconUrl, appTitle] = decrypted.split('\n');
                            
                            if (iconUrl && appTitle) {
                                updateIconAndTitle(iconUrl, appTitle);
                                showAlert('Icon and app title updated successfully.');
                            } else {
                                showAlert('Invalid icon config file format.');
                            }
                        } catch (error) {
                            showAlert('Decryption error: ' + error.message);
                        }
                    } else {
                        showAlert('Passphrase is required for decryption.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function updateIconAndTitle(iconUrl, appTitle) {
            const appleTouchIcon = document.querySelector('link[rel="apple-touch-icon"]');
            if (appleTouchIcon) {
                appleTouchIcon.href = iconUrl;
            } else {
                const newLink = document.createElement('link');
                newLink.rel = 'apple-touch-icon';
                newLink.href = iconUrl;
                document.head.appendChild(newLink);
            }

            const appTitleMeta = document.querySelector('meta[name="apple-mobile-web-app-title"]');
            if (appTitleMeta) {
                appTitleMeta.content = appTitle;
            } else {
                const newMeta = document.createElement('meta');
                newMeta.name = 'apple-mobile-web-app-title';
                newMeta.content = appTitle;
                document.head.appendChild(newMeta);
            }
        }

        // Add event listener for the upload icon config button
        document.addEventListener('DOMContentLoaded', function() {
            const uploadIconConfigButton = document.getElementById('uploadIconConfigButton');
            const iconConfigInput = document.createElement('input');
            iconConfigInput.type = 'file';
            iconConfigInput.style.display = 'none';
            
            uploadIconConfigButton.addEventListener('click', function() {
                iconConfigInput.click();
            });
            
            iconConfigInput.addEventListener('change', handleIconConfigUpload);
            
            document.body.appendChild(iconConfigInput);
        });
    </script>
</body>
</html>